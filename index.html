<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An√°lise de Visitas - BPM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --accent-bright: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --surface: #1e293b;
            --surface-light: #334155;
            --border: #334155;
            --glow: rgba(59, 130, 246, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .noise {
            position: fixed;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noiseFilter"><feTurbulence type="fractalNoise" baseFrequency="3.5" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noiseFilter)" opacity="0.03"/></svg>');
            opacity: 0.5;
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
            font-family: 'Space Mono', monospace;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 300;
        }

        .mode-toggle {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .mode-btn {
            background: var(--surface-light);
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 0.8rem 1.8rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-bright) 100%);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 15px var(--glow);
        }

        .mode-btn:hover:not(.active) {
            background: var(--surface);
            border-color: var(--accent);
        }

        .upload-section {
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 3rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--glow);
            transform: translateY(-2px);
        }

        .upload-section:hover::before {
            opacity: 1;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-bright) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-light);
            box-shadow: none;
            margin-left: 1rem;
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        #dashboard-incursao, #dashboard-denuncia {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.8rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out both;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-bright) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            border-color: var(--accent);
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text);
            font-family: 'Space Mono', monospace;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            justify-content: center;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        .stat-change.neutral { color: var(--text-muted); }

        .areas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .area-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out both;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .area-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-bright);
        }

        .area-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .area-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.3rem;
            line-height: 1.3;
        }

        .area-badge {
            background: var(--accent);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .area-badge.high { background: var(--danger); }
        .area-badge.medium { background: var(--warning); }
        .area-badge.low { background: var(--success); }

        .area-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .area-stat {
            background: var(--secondary);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .area-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.3rem;
        }

        .area-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            font-family: 'Space Mono', monospace;
        }

        .progress-bar {
            height: 8px;
            background: var(--secondary);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-bright) 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .chart-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            border: 1px solid var(--border);
            animation: fadeIn 0.8s ease-out 0.6s both;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        canvas {
            max-height: 400px;
        }

        .duplicates-table {
            background: var(--surface);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            animation: fadeIn 0.8s ease-out 0.8s both;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: var(--secondary);
            color: var(--text);
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child {
            border-top-left-radius: 10px;
        }

        th:last-child {
            border-top-right-radius: 10px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        tr:hover td {
            background: var(--secondary);
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .badge-high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .badge-low {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--surface);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            width: 90%;
            max-width: 1200px;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .close-modal {
            color: var(--text-muted);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--accent);
        }

        .modal-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .modal-tab {
            background: var(--secondary);
            color: var(--text);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-tab.active {
            background: var(--accent);
            color: white;
        }

        .modal-tab:hover:not(.active) {
            background: var(--surface-light);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
        }

        .modal-table th {
            background: var(--secondary);
            padding: 0.75rem;
            font-size: 0.8rem;
        }

        .modal-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .modal-table tr:hover td {
            background: var(--secondary);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 3rem;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease-out 1s both;
        }

        @media print {
            body {
                background: white !important;
                color: #333 !important;
                font-family: Arial, sans-serif !important;
            }
            
            .noise, .upload-section, .export-buttons,
            .btn, .spinner, .loading, .modal {
                display: none !important;
            }
            
            #dashboard {
                display: block !important;
                background: white !important;
                color: #333 !important;
            }
            
            .stat-card, .area-card, .chart-container, .duplicates-table {
                background: white !important;
                color: #333 !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                break-inside: avoid;
            }
            
            .stat-label, .area-stat-label, .subtitle,
            .stat-change, .area-title {
                color: #666 !important;
            }
            
            .stat-value, .area-stat-value, .chart-title {
                color: #222 !important;
            }
            
            .progress-bar {
                background: #f0f0f0 !important;
            }
            
            .progress-fill {
                background: #4a90e2 !important;
            }
            
            table {
                border: 1px solid #ddd !important;
            }
            
            th {
                background: #f8f8f8 !important;
                color: #333 !important;
                border-bottom: 2px solid #ddd !important;
            }
            
            td {
                color: #333 !important;
                border-bottom: 1px solid #ddd !important;
            }
            
            .badge-high, .badge-medium, .badge-low {
                background: transparent !important;
                border: 1px solid #333 !important;
                color: #333 !important;
            }
            
            .print-report {
                display: block !important;
            }
            
            .page-break {
                page-break-before: always;
                break-before: page;
            }
            
            .avoid-break {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .areas-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .export-buttons {
                flex-direction: column;
            }

            .btn-secondary {
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        .denuncia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .denuncia-card {
            text-align: center;
            background: var(--surface);
            border-radius: 16px;
            padding: 1.8rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .denuncia-card-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .denuncia-card-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text);
            font-family: 'Space Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .denuncia-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .denuncia-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .denuncia-item:last-child {
            border-bottom: none;
        }

        .city-filter {
            margin: 1rem 0;
            text-align: center;
        }

        .city-filter select {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            max-width: 300px;
            width: 100%;
        }

        .duplicate-metrics {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .duplicate-metric {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }

        .duplicate-metric strong {
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="noise"></div>
    <div class="container">
        <header>
            <h1>OPERA√á√ÉO BARRICADA ZERO</h1>
            <p class="subtitle">SISTEMA INTEGRADO DE AN√ÅLISE OPERACIONAL</p>
            <div class="mode-toggle">
                <button class="mode-btn active" id="btnIncursao">AN√ÅLISE DE INCURS√ïES</button>
                <button class="mode-btn" id="btnDenuncia">AN√ÅLISE DE DEN√öNCIAS</button>
            </div>
        </header>

        <!-- Se√ß√£o de Incurs√µes -->
        <div id="uploadSectionIncursao" class="upload-section">
            <div class="upload-icon">üìä</div>
            <h2 style="margin-bottom: 1rem;">Importar Planilha de Incurs√µes</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Selecione um arquivo .xlsx com a aba "VIAS" para an√°lise
            </p>
            <input type="file" id="fileInputIncursao" accept=".xlsx">
            <label for="fileInputIncursao" class="btn">
                Selecionar Arquivo
            </label>
        </div>

        <!-- Se√ß√£o de Den√∫ncias -->
        <div id="uploadSectionDenuncia" class="upload-section" style="display: none;">
            <div class="upload-icon">‚ö†Ô∏è</div>
            <h2 style="margin-bottom: 1rem;">Importar Planilha de Den√∫ncias</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Selecione um arquivo .xlsx com as abas "Recoloca√ß√£o.DD" e "GLOBAL" para an√°lise
            </p>
            <input type="file" id="fileInputDenuncia" accept=".xlsx">
            <label for="fileInputDenuncia" class="btn">
                Selecionar Arquivo
            </label>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processando dados...</p>
        </div>

        <!-- Dashboard de Incurs√µes -->
        <div id="dashboard-incursao">
            <div class="export-buttons">
                <button class="btn" onclick="exportToPDF('incursao')">üìÑ Exportar Relat√≥rio PDF</button>
                <button class="btn btn-secondary" onclick="printDashboard('incursao')">üñ®Ô∏è Visualizar/Imprimir Relat√≥rio</button>
            </div>

            <div class="stats-grid" id="statsGrid"></div>

            <div class="chart-container">
                <h3 class="chart-title">Distribui√ß√£o de Duplicatas por √Årea</h3>
                <canvas id="areaChart"></canvas>
            </div>

            <div class="areas-grid" id="areasGrid"></div>

            <div class="chart-container">
                <h3 class="chart-title">Comparativo de Performance</h3>
                <canvas id="comparisonChart"></canvas>
            </div>

            <div class="duplicates-table">
                <h3 class="chart-title">Top 20 Endere√ßos Mais Visitados</h3>
                <div style="overflow-x: auto;">
                    <table id="duplicatesTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Endere√ßo</th>
                                <th>√Årea</th>
                                <th>Visitas</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard de Den√∫ncias -->
        <div id="dashboard-denuncia" style="display: none;">
            <div class="export-buttons">
                <button class="btn" onclick="exportDenunciasPDF()">üìÑ Exportar Relat√≥rio PDF</button>
                <button class="btn btn-secondary" onclick="previewDenunciasPDF()">üëÅÔ∏è Preview PDF</button>
            </div>

            <div class="city-filter">
                <select id="cidadeFilter" class="form-control" onchange="renderDenunciasDashboard()">
                    <option value="">Todas as Cidades</option>
                </select>
            </div>

            <div class="denuncia-grid" id="denunciaStatsGrid"></div>

            <div class="chart-container">
                <h3 class="chart-title">Distribui√ß√£o por Cidade</h3>
                <canvas id="cidadeChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Tipos de Barricada</h3>
                <canvas id="tipoBarricadaChart"></canvas>
            </div>

            <div class="duplicates-table">
                <h3 class="chart-title">Top Materiais Utilizados</h3>
                <table id="materiaisTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Material</th>
                            <th>Ocorr√™ncias</th>
                            <th>Percentual</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes da √°rea -->
    <div id="areaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalAreaTitle">Detalhes da √Årea</h2>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="duplicates">Endere√ßos Duplicados</button>
                <button class="modal-tab" data-tab="mostVisited">Mais Visitados</button>
            </div>
            
            <div id="duplicatesTab" class="tab-content active">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Endere√ßo</th>
                            <th>Visitas</th>
                            <th>Linhas na Planilha</th>
                        </tr>
                    </thead>
                    <tbody id="modalDuplicatesTable"></tbody>
                </table>
            </div>
            
            <div id="mostVisitedTab" class="tab-content">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Endere√ßo</th>
                            <th>Visitas</th>
                            <th>Linhas na Planilha</th>
                        </tr>
                    </thead>
                    <tbody id="modalMostVisitedTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para ranking de cidades -->
    <div id="cidadesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ranking Completo de Cidades</h2>
                <span class="close-modal" id="closeCidadesModal">&times;</span>
            </div>
            <div class="modal-body">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Cidade</th>
                            <th>Den√∫ncias</th>
                            <th>Percentual</th>
                        </tr>
                    </thead>
                    <tbody id="cidadesTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes de duplicados -->
    <div id="duplicatesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="modal-title">Detalhes de Registros Duplicados</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn" onclick="generateRecolocacoesPDF()" style="padding: 0.5rem 1rem; font-size: 0.85rem;">üìÑ Exportar PDF</button>
                    <span class="close-modal" id="closeDuplicatesModalBtn" style="position: static;">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--text-muted);">Lista de endere√ßos com m√∫ltiplas den√∫ncias e seus respectivos n√∫meros de Registro:</p>
                <div id="duplicatesList" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Conte√∫do din√¢mico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Preview PDF -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90%;">
            <div class="modal-header">
                <h2 class="modal-title">Preview do Relat√≥rio PDF</h2>
                <span class="close-modal" id="closePdfPreview">&times;</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <iframe id="pdfPreviewIframe" style="width: 100%; height: 70vh; border: none;"></iframe>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 1rem;">
                <button class="btn btn-secondary" onclick="closePdfPreview()">Fechar</button>
                <button class="btn" onclick="downloadPDFFromPreview()">Baixar PDF</button>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let analysisData = null;
        let denunciasData = null;
        let areaChart = null;
        let comparisonChart = null;
        let cidadeChart = null;
        let tipoBarricadaChart = null;
        let currentAreaDetails = null;
        let currentMode = 'incursao';
        let currentPDFDataUrl = '';
        let totalRemocoesGlobal = 0;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('btnIncursao').addEventListener('click', () => switchMode('incursao'));
            document.getElementById('btnDenuncia').addEventListener('click', () => switchMode('denuncia'));
            
            document.getElementById('fileInputIncursao').addEventListener('change', handleFileIncursao);
            document.getElementById('fileInputDenuncia').addEventListener('change', handleFileDenuncia);
            
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeCidadesModal').addEventListener('click', closeCidadesModal);
            document.getElementById('closeDuplicatesModalBtn').addEventListener('click', closeDuplicatesModal);
            document.getElementById('closePdfPreview').addEventListener('click', closePdfPreview);
            
            document.getElementById('areaModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            document.getElementById('cidadesModal').addEventListener('click', function(e) {
                if (e.target === this) closeCidadesModal();
            });

            document.getElementById('duplicatesModal').addEventListener('click', function(e) {
                if (e.target === this) closeDuplicatesModal();
            });
            
            document.getElementById('pdfPreviewModal').addEventListener('click', function(e) {
                if (e.target === this) closePdfPreview();
            });

            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    if (currentAreaDetails) {
                        if (tabId === 'duplicates') {
                            renderDuplicatesTableModal(currentAreaDetails);
                        } else if (tabId === 'mostVisited') {
                            renderMostVisitedTable(currentAreaDetails);
                        }
                    }
                });
            });
        });

        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            document.getElementById('uploadSectionIncursao').style.display = mode === 'incursao' ? 'block' : 'none';
            document.getElementById('uploadSectionDenuncia').style.display = mode === 'denuncia' ? 'block' : 'none';
            
            document.getElementById('dashboard-incursao').style.display = mode === 'incursao' && analysisData ? 'block' : 'none';
            document.getElementById('dashboard-denuncia').style.display = mode === 'denuncia' && denunciasData ? 'block' : 'none';
        }

        // ======================= INCURS√ïES =======================
        function handleFileIncursao(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading').classList.add('active');
            document.getElementById('uploadSectionIncursao').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames.includes('VIAS')) {
                        throw new Error('A planilha n√£o cont√©m a aba "VIAS". Por favor, verifique o arquivo.');
                    }
                    
                    const worksheet = workbook.Sheets['VIAS'];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processIncursaoData(jsonData);
                    setTimeout(() => {
                        document.getElementById('loading').classList.remove('active');
                        document.getElementById('dashboard-incursao').style.display = 'block';
                        renderIncursaoDashboard();
                    }, 500);
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    alert('Erro ao processar arquivo: ' + error.message);
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('uploadSectionIncursao').style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processIncursaoData(data) {
            const headers = data[0];
            const rows = data.slice(1);

            const areaIndices = [0, 3, 6, 9, 12, 15, 18];
            const areas = {};

            areaIndices.forEach(idx => {
                if (idx < headers.length && headers[idx]) {
                    const areaName = headers[idx];
                    areas[areaName] = {
                        name: areaName,
                        addresses: {},
                        totalAddresses: 0,
                        uniqueAddresses: 0,
                        duplicatedAddresses: 0,
                        duplicates: [],
                        allAddresses: []
                    };
                }
            });

            rows.forEach((row, rowIdx) => {
                areaIndices.forEach(idx => {
                    const areaName = headers[idx];
                    if (!areaName || !areas[areaName]) return;

                    const address = row[idx];
                    if (address && typeof address === 'string' && address.trim()) {
                        const cleanAddress = address.trim();
                        
                        if (!areas[areaName].addresses[cleanAddress]) {
                            areas[areaName].addresses[cleanAddress] = {
                                address: cleanAddress,
                                count: 0,
                                rows: []
                            };
                        }
                        
                        areas[areaName].addresses[cleanAddress].count++;
                        areas[areaName].addresses[cleanAddress].rows.push(rowIdx + 2);
                    }
                });
            });

            Object.values(areas).forEach(area => {
                area.totalAddresses = Object.keys(area.addresses).length;
                area.allAddresses = Object.values(area.addresses);
                area.allAddresses.sort((a, b) => b.count - a.count);
                
                Object.values(area.addresses).forEach(addr => {
                    if (addr.count === 1) {
                        area.uniqueAddresses++;
                    } else {
                        area.duplicatedAddresses++;
                        area.duplicates.push(addr);
                    }
                });

                area.duplicates.sort((a, b) => b.count - a.count);
            });

            analysisData = {
                areas: areas,
                totalAreas: Object.keys(areas).length,
                totalDuplicates: Object.values(areas).reduce((sum, area) => sum + area.duplicatedAddresses, 0),
                totalAddresses: Object.values(areas).reduce((sum, area) => sum + area.totalAddresses, 0),
                maxVisits: Math.max(...Object.values(areas).flatMap(area => 
                    area.allAddresses.map(d => d.count)
                ), 0)
            };
        }

        function renderIncursaoDashboard() {
            renderIncursaoStats();
            renderAreaCards();
            renderIncursaoCharts();
            renderDuplicatesTable();
        }

        function renderIncursaoStats() {
            const statsGrid = document.getElementById('statsGrid');
            const duplicationRate = analysisData.totalAddresses > 0 
                ? (analysisData.totalDuplicates / analysisData.totalAddresses * 100).toFixed(1)
                : 0;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total de √Åreas</div>
                    <div class="stat-value">${analysisData.totalAreas}</div>
                    <div class="stat-change neutral">Monitoradas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Endere√ßos √önicos</div>
                    <div class="stat-value">${analysisData.totalAddresses}</div>
                    <div class="stat-change neutral">Cadastrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Endere√ßos Duplicados</div>
                    <div class="stat-value">${analysisData.totalDuplicates}</div>
                    <div class="stat-change ${analysisData.totalDuplicates > 50 ? 'negative' : 'neutral'}">
                        ${duplicationRate}% do total
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Maior N¬∫ Visitas</div>
                    <div class="stat-value">${analysisData.maxVisits}</div>
                    <div class="stat-change ${analysisData.maxVisits > 5 ? 'negative' : 'neutral'}">
                        Mesmo endere√ßo
                    </div>
                </div>
            `;
        }

        function renderAreaCards() {
            const areasGrid = document.getElementById('areasGrid');
            const areasList = Object.values(analysisData.areas);

            areasGrid.innerHTML = areasList.map(area => {
                const duplicationRate = area.totalAddresses > 0 
                    ? (area.duplicatedAddresses / area.totalAddresses * 100).toFixed(1)
                    : 0;
                
                const badgeClass = area.duplicatedAddresses > 50 ? 'high' : 
                                   area.duplicatedAddresses > 20 ? 'medium' : 'low';
                
                const maxVisits = area.duplicates.length > 0 
                    ? Math.max(...area.duplicates.map(d => d.count))
                    : 0;

                return `
                    <div class="area-card" onclick="openAreaModal('${area.name.replace(/'/g, "\\'")}')">
                        <div class="area-header">
                            <div>
                                <div class="area-title">${area.name}</div>
                            </div>
                            <div class="area-badge ${badgeClass}">${area.duplicatedAddresses}</div>
                        </div>
                        <div class="area-stats">
                            <div class="area-stat">
                                <div class="area-stat-label">Total de Vias</div>
                                <div class="area-stat-value">${area.totalAddresses}</div>
                            </div>
                            <div class="area-stat">
                                <div class="area-stat-label">Vias √önicas</div>
                                <div class="area-stat-value">${area.uniqueAddresses}</div>
                            </div>
                            <div class="area-stat">
                                <div class="area-stat-label">Vias Duplicadas</div>
                                <div class="area-stat-value">${area.duplicatedAddresses}</div>
                            </div>
                            <div class="area-stat">
                                <div class="area-stat-label">M√°ximo de Visitas</div>
                                <div class="area-stat-value">${maxVisits}</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${duplicationRate}%"></div>
                        </div>
                        <div style="text-align: right; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                            ${duplicationRate}% de duplica√ß√£o
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderIncursaoCharts() {
            const areasList = Object.values(analysisData.areas);

            const ctx1 = document.getElementById('areaChart').getContext('2d');
            if (areaChart) areaChart.destroy();
            
            areaChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: areasList.map(a => a.name.split(' ')[0]),
                    datasets: [{
                        label: 'Endere√ßos Duplicados',
                        data: areasList.map(a => a.duplicatedAddresses),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('comparisonChart').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();
            
            comparisonChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: areasList.map(a => a.name.split(' ')[0]),
                    datasets: [
                        {
                            label: 'Total de Endere√ßos',
                            data: areasList.map(a => a.totalAddresses),
                            borderColor: 'rgba(96, 165, 250, 1)',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Endere√ßos √önicos',
                            data: areasList.map(a => a.uniqueAddresses),
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Endere√ßos Duplicados',
                            data: areasList.map(a => a.duplicatedAddresses),
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f1f5f9',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function renderDuplicatesTable() {
            const tbody = document.querySelector('#duplicatesTable tbody');
            
            const allDuplicates = [];
            Object.values(analysisData.areas).forEach(area => {
                area.duplicates.forEach(dup => {
                    allDuplicates.push({
                        address: dup.address,
                        area: area.name,
                        count: dup.count,
                        rows: dup.rows
                    });
                });
            });

            allDuplicates.sort((a, b) => b.count - a.count);

            tbody.innerHTML = allDuplicates.slice(0, 20).map((dup, idx) => {
                const badgeClass = dup.count >= 5 ? 'badge-high' : 
                                   dup.count >= 3 ? 'badge-medium' : 'badge-low';
                
                return `
                    <tr>
                        <td><strong>${idx + 1}</strong></td>
                        <td>${dup.address}</td>
                        <td>${dup.area.split(' ')[0]}</td>
                        <td><strong>${dup.count}</strong></td>
                        <td><span class="badge ${badgeClass}">${dup.count >= 5 ? 'ALTA' : dup.count >= 3 ? 'M√âDIA' : 'BAIXA'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function openAreaModal(areaName) {
            const area = analysisData.areas[areaName];
            if (!area) return;

            currentAreaDetails = area;
            
            document.getElementById('modalAreaTitle').textContent = `Detalhes da √Årea: ${area.name}`;
            renderDuplicatesTableModal(area);
            renderMostVisitedTable(area);
            
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('.modal-tab[data-tab="duplicates"]').classList.add('active');
            document.getElementById('duplicatesTab').classList.add('active');
            
            document.getElementById('areaModal').style.display = 'block';
        }

        function renderDuplicatesTableModal(area) {
            const tbody = document.getElementById('modalDuplicatesTable');
            
            tbody.innerHTML = area.duplicates.map((dup, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${dup.address}</td>
                    <td>${dup.count}</td>
                    <td>${dup.rows.join(', ')}</td>
                </tr>
            `).join('');
        }

        function renderMostVisitedTable(area) {
            const tbody = document.getElementById('modalMostVisitedTable');
            const mostVisited = area.allAddresses;
            
            tbody.innerHTML = mostVisited.map((addr, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${addr.address}</td>
                    <td>${addr.count}</td>
                    <td>${addr.rows.join(', ')}</td>
                </tr>
            `).join('');
        }

        function closeModal() {
            document.getElementById('areaModal').style.display = 'none';
        }

        // ======================= DEN√öNCIAS =======================
        function handleFileDenuncia(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading').classList.add('active');
            document.getElementById('uploadSectionDenuncia').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Verificar se ambas as abas existem
                    if (!workbook.SheetNames.includes('Recoloca√ß√£o.DD')) {
                        throw new Error('A planilha n√£o cont√©m a aba "Recoloca√ß√£o.DD". Por favor, verifique o arquivo.');
                    }
                    
                    if (!workbook.SheetNames.includes('GLOBAL')) {
                        throw new Error('A planilha n√£o cont√©m a aba "GLOBAL". Por favor, verifique o arquivo.');
                    }
                    
                    // Processar aba GLOBAL para obter total de remo√ß√µes
                    const globalWorksheet = workbook.Sheets['GLOBAL'];
                    const globalData = XLSX.utils.sheet_to_json(globalWorksheet, { header: 1 });
                    const totalRemocoes = processGlobalData(globalData);
                    
                    // Processar aba Recoloca√ß√£o.DD
                    const recolocacaoWorksheet = workbook.Sheets['Recoloca√ß√£o.DD'];
                    const recolocacaoData = XLSX.utils.sheet_to_json(recolocacaoWorksheet, { header: 1 });
                    
                    processDenunciaData(recolocacaoData, totalRemocoes);
                    setTimeout(() => {
                        document.getElementById('loading').classList.remove('active');
                        document.getElementById('dashboard-denuncia').style.display = 'block';
                        renderDenunciasDashboard();
                    }, 500);
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    alert('Erro ao processar arquivo: ' + error.message);
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('uploadSectionDenuncia').style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processGlobalData(data) {
            // A coluna "REMO√á√ïES" est√° no √≠ndice 5 (coluna F, se come√ßar em 0)
            const REMOCOES_INDEX = 5;
            
            if (!data || data.length === 0) {
                console.warn('A aba GLOBAL est√° vazia ou n√£o cont√©m dados.');
                return 0;
            }
            
            // Verificar se h√° dados suficientes
            if (data.length < 2) {
                console.warn('A aba GLOBAL n√£o cont√©m dados suficientes.');
                return 0;
            }
            
            // Pular cabe√ßalho e somar valores da coluna 5
            let totalRemocoes = 0;
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row && row.length > REMOCOES_INDEX) {
                    const valor = row[REMOCOES_INDEX];
                    
                    // Converter para n√∫mero se poss√≠vel
                    if (valor !== undefined && valor !== null && valor !== '') {
                        const num = Number(valor);
                        if (!isNaN(num)) {
                            totalRemocoes += num;
                        } else {
                            // Tentar extrair n√∫mero de string
                            const match = String(valor).match(/\d+/);
                            if (match) {
                                totalRemocoes += Number(match[0]);
                            }
                        }
                    }
                }
            }
            
            console.log(`Total de remo√ß√µes encontrado na aba GLOBAL (√≠ndice ${REMOCOES_INDEX}):`, totalRemocoes);
            return totalRemocoes;
        }

        function processDenunciaData(data, totalRemocoes) {
            totalRemocoesGlobal = totalRemocoes;
            
            const headers = data[0];
            const rows = data.slice(1);

            const denuncias = rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            }).filter(item => {
                const endereco = (item['Endere√ßo'] || '').toString().trim();
                return endereco !== '' && endereco.toUpperCase() !== 'NI';
            });

            // Contagem por cidade
            const cidadeCounts = {};
            const tipoCounts = {};
            const materialCounts = {};
            const statusCounts = {};
            const faccaoCounts = {};
            const duplicateMap = new Map();

            denuncias.forEach(item => {
                // Identificar duplicados por Endere√ßo
                const endereco = (item['Endere√ßo'] || '').toString().trim().toUpperCase();
                const key = endereco;
                
                if (endereco && endereco !== 'NI') {
                    if (!duplicateMap.has(key)) {
                        duplicateMap.set(key, []);
                    }
                    duplicateMap.get(key).push(item);
                }

                // Cidade
                const cidade = item['Cidade'] || '';
                cidadeCounts[cidade] = (cidadeCounts[cidade] || 0) + 1;

                // Tipo de barricada
                const tipo = item['Tipo de Barricada'] || 'Desconhecido';
                tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;

                // Materiais
                const materiais = [
                    item['Material 1'],
                    item['Material 2'],
                    item['Material 3']
                ].filter(m => m && m !== 'NI' && m.trim() !== '');
                
                materiais.forEach(mat => {
                    const material = mat.trim().toUpperCase();
                    materialCounts[material] = (materialCounts[material] || 0) + 1;
                });

                // Status
                const status = item['Status'] || 'Sem Tratamento';
                statusCounts[status] = (statusCounts[status] || 0) + 1;

                // Fac√ß√£o
                const obs = (item['Observa√ß√µes'] || '').toLowerCase();
                const denuncia = (item['Den√∫ncia'] || '').toLowerCase();
                const textoCompleto = obs + ' ' + denuncia;
                
                if (textoCompleto.includes('comando vermelho') || textoCompleto.includes('cv')) {
                    faccaoCounts['COMANDO VERMELHO'] = (faccaoCounts['COMANDO VERMELHO'] || 0) + 1;
                }
                if (textoCompleto.includes('terceiro comando') || textoCompleto.includes('tcp')) {
                    faccaoCounts['TERCEIRO COMANDO PURO'] = (faccaoCounts['TERCEIRO COMANDO PURO'] || 0) + 1;
                }
            });

            // Encontrar fac√ß√£o mais citada
            const faccaoMaisCitada = Object.entries(faccaoCounts).sort((a, b) => b[1] - a[1])[0];

            // Calcular porcentagens
            const total = denuncias.length;
            const cidadeMaisAfetada = Object.entries(cidadeCounts).sort((a, b) => b[1] - a[1])[0];

            // Tipos fixas vs m√≥veis
            let fixas = 0;
            let moveis = 0;
            Object.entries(tipoCounts).forEach(([tipo, count]) => {
                if (tipo.toUpperCase().includes('FIXA')) fixas += count;
                if (tipo.toUpperCase().includes('M√ìVEL') || tipo.toUpperCase().includes('MOVEIS')) moveis += count;
            });

            // Top materiais
            const topMateriais = Object.entries(materialCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Top status
            const topStatus = Object.entries(statusCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // C√°lculo das m√©tricas de duplicados
            let totalEnderecosUnicos = 0;
            let totalEnderecosReincidentes = 0;
            let totalRegistrosAfetados = 0;

            duplicateMap.forEach((items, key) => {
                if (key && key !== 'NI') {
                    totalEnderecosUnicos++;
                    if (items.length > 1) {
                        totalEnderecosReincidentes++;
                        totalRegistrosAfetados += items.length;
                    }
                }
            });

            // Calcular taxa de recoloca√ß√£o CORRETAMENTE
            // F√≥rmula: (totalEnderecosUnicos / (totalRemocoesGlobal/4)) * 100
            const taxaRecolocacao = totalRemocoesGlobal > 0 
                ? ((totalEnderecosUnicos / (totalRemocoesGlobal/4)) * 100).toFixed(1)
                : 0;

            console.log('C√°lculo da taxa de recoloca√ß√£o:');
            console.log(`- Total de endere√ßos √∫nicos (recolocados): ${totalEnderecosUnicos}`);
            console.log(`- Total de remo√ß√µes: ${(totalRemocoesGlobal/4)}`);
            console.log(`- Taxa de recoloca√ß√£o: ${taxaRecolocacao}%`);

            denunciasData = {
                denuncias: denuncias,
                total: total,
                cidadeCounts: cidadeCounts,
                tipoCounts: tipoCounts,
                materialCounts: materialCounts,
                statusCounts: statusCounts,
                faccaoCounts: faccaoCounts,
                cidadeMaisAfetada: cidadeMaisAfetada,
                faccaoMaisCitada: faccaoMaisCitada,
                fixas: fixas,
                moveis: moveis,
                topMateriais: topMateriais,
                topStatus: topStatus,
                duplicateMap: duplicateMap,
                // Novas m√©tricas
                totalEnderecosUnicos: totalEnderecosUnicos,
                totalEnderecosReincidentes: totalEnderecosReincidentes,
                totalRegistrosAfetados: totalRegistrosAfetados,
                totalRemocoesGlobal: totalRemocoesGlobal,
                taxaRecolocacao: taxaRecolocacao
            };

            // Popular filtro de cidades
            const cidadeSelect = document.getElementById('cidadeFilter');
            cidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
            Object.keys(cidadeCounts).filter(c => c && c !== 'Desconhecida').sort().forEach(cidade => {
                const option = document.createElement('option');
                option.value = cidade;
                option.textContent = cidade;
                cidadeSelect.appendChild(option);
            });
        }

        function renderDenunciasDashboard() {
            const cidade = document.getElementById('cidadeFilter').value;
            const filteredData = cidade ? 
                denunciasData.denuncias.filter(d => (d['Cidade'] || '') === cidade) : 
                denunciasData.denuncias;
            
            const total = filteredData.length;

            // Recalcular para dados filtrados
            const tipoCounts = {};
            const materialCounts = {};
            const statusCounts = {};
            const faccaoCounts = {};
            const currentDuplicateMap = new Map();

            filteredData.forEach(item => {
                const endereco = (item['Endere√ßo'] || '').toString().trim().toUpperCase();
                const key = endereco;
                
                if (endereco && endereco !== 'NI') {
                    if (!currentDuplicateMap.has(key)) {
                        currentDuplicateMap.set(key, []);
                    }
                    currentDuplicateMap.get(key).push(item);
                }

                const tipo = item['Tipo de Barricada'] || 'Desconhecido';
                tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;

                const materiais = [
                    item['Material 1'],
                    item['Material 2'],
                    item['Material 3']
                ].filter(m => m && m !== 'NI' && m.trim() !== '');
                
                materiais.forEach(mat => {
                    const material = mat.trim().toUpperCase();
                    materialCounts[material] = (materialCounts[material] || 0) + 1;
                });

                const status = item['Status'] || 'Sem Tratamento';
                statusCounts[status] = (statusCounts[status] || 0) + 1;

                const obs = (item['Observa√ß√µes'] || '').toLowerCase();
                const denuncia = (item['Den√∫ncia'] || '').toLowerCase();
                const textoCompleto = obs + ' ' + denuncia;
                
                if (textoCompleto.includes('comando vermelho') || textoCompleto.includes('cv')) {
                    faccaoCounts['COMANDO VERMELHO'] = (faccaoCounts['COMANDO VERMELHO'] || 0) + 1;
                }
                if (textoCompleto.includes('terceiro comando') || textoCompleto.includes('tcp')) {
                    faccaoCounts['TERCEIRO COMANDO PURO'] = (faccaoCounts['TERCEIRO COMANDO PURO'] || 0) + 1;
                }
            });

            const faccaoMaisCitada = Object.entries(faccaoCounts).sort((a, b) => b[1] - a[1])[0] || ['Nenhuma', 0];
            
            let fixas = 0;
            let moveis = 0;
            Object.entries(tipoCounts).forEach(([tipo, count]) => {
                if (tipo.toUpperCase().includes('FIXA')) fixas += count;
                if (tipo.toUpperCase().includes('M√ìVEL') || tipo.toUpperCase().includes('MOVEIS')) moveis += count;
            });

            const topMateriais = Object.entries(materialCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Calcular m√©tricas de duplicados para dados filtrados
            let totalEnderecosUnicosFiltrados = 0;
            let totalEnderecosReincidentesFiltrados = 0;
            let totalRegistrosAfetadosFiltrados = 0;

            currentDuplicateMap.forEach((items, key) => {
                if (key && key !== 'NI') {
                    totalEnderecosUnicosFiltrados++;
                    if (items.length > 1) {
                        totalEnderecosReincidentesFiltrados++;
                        totalRegistrosAfetadosFiltrados += items.length;
                    }
                }
            });

            // Calcular taxa de recoloca√ß√£o para dados filtrados
            const taxaRecolocacaoFiltrada = denunciasData.totalRemocoesGlobal > 0 
                ? ((totalEnderecosUnicosFiltrados / (denunciasData.totalRemocoesGlobal/4)) * 100).toFixed(1)
                : 0;

            // Calcular efici√™ncia operacional (100% - taxa de recoloca√ß√£o)
            const eficienciaOperacional = (100 - parseFloat(taxaRecolocacaoFiltrada)).toFixed(1);

            // Atualizar estat√≠sticas
            const statsGrid = document.getElementById('denunciaStatsGrid');
            const fixasPct = total > 0 ? ((fixas / total) * 100).toFixed(1) : 0;
            const moveisPct = total > 0 ? ((moveis / total) * 100).toFixed(1) : 0;

            statsGrid.innerHTML = `
                <div class="denuncia-card">
                    <div class="denuncia-card-header">üìã Total de Den√∫ncias</div>
                    <div class="denuncia-card-value">${total}</div>
                    <div class="stat-change neutral">Ocorr√™ncias de Recoloca√ß√£o</div>
                </div>
                
                <div class="denuncia-card">
                    <div class="denuncia-card-header">üìç Cidade Mais Afetada</div>
                    <div class="denuncia-card-value">${denunciasData.cidadeMaisAfetada ? denunciasData.cidadeMaisAfetada[0].substring(0, 15) : 'N/A'}</div>
                    <div class="stat-change neutral">${denunciasData.cidadeMaisAfetada ? denunciasData.cidadeMaisAfetada[1] : 0} ocorr√™ncias</div>
                    <button class="btn" style="margin-top: 1rem; width: 100%;" onclick="showCidadesModal()">Ver Ranking Completo</button>
                </div>
                
                <div class="denuncia-card">
                    <div class="denuncia-card-header">‚ö†Ô∏è Tipos de Barricada</div>
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Fixas: ${fixas} (${fixasPct}%)</div>
                    <div style="font-size: 1.2rem;">M√≥veis: ${moveis} (${moveisPct}%)</div>
                    <div class="progress-bar" style="margin-top: 1rem;">
                        <div class="progress-fill" style="width: ${fixasPct}%"></div>
                    </div>
                </div>
                
                <div class="denuncia-card">
                    <div class="denuncia-card-header">üè¥ Fac√ß√£o Mais Citada</div>
                    <div class="denuncia-card-value">${faccaoMaisCitada[0]}</div>
                    <div class="stat-change neutral">${faccaoMaisCitada[1]} men√ß√µes</div>
                </div>
                
                <div class="denuncia-card" onclick="showDuplicatesModal()" style="cursor: pointer; transition: transform 0.2s;">
                    <div class="denuncia-card-header">üîÑ Resumo das Recoloca√ß√µes</div>
                    <div class="duplicate-metrics">
                        <div class="duplicate-metric">Barricadas Recolocadas: <strong>${totalEnderecosUnicosFiltrados}</strong></div>
                        <div class="duplicate-metric">Logradouros Repetidos: <strong>${totalEnderecosReincidentesFiltrados}</strong></div>
                        <div class="duplicate-metric">Denunciadas mais de 1 vez: <strong>${totalRegistrosAfetadosFiltrados}</strong></div>
                        <div class="duplicate-metric" style="color: var(--danger); font-weight: 700;">Taxa de Recoloca√ß√£o: <strong>${taxaRecolocacaoFiltrada}%</strong></div>
                    </div>
                    <button class="btn" style="margin-top: 1rem; width: 100%;">Ver Detalhes</button>
                </div>
                
                <div class="denuncia-card">
                    <div class="denuncia-card-header">üìä Dados de Remo√ß√£o</div>
                    <div class="duplicate-metrics">
                        <div class="duplicate-metric">Total de Remo√ß√µes: <strong>${(denunciasData.totalRemocoesGlobal/4)}</strong></div>
                        <div class="duplicate-metric" style="color: var(--danger); font-weight: 700;">Taxa de Recoloca√ß√£o: <strong>${taxaRecolocacaoFiltrada}%</strong></div>
                        <div class="duplicate-metric" style="color: var(--success); font-weight: 700;">Efici√™ncia Operacional: <strong>${eficienciaOperacional}%</strong></div>
                    </div>
                </div>
                
                <div class="denuncia-card">
                    <div class="denuncia-card-header">üèóÔ∏è Materiais Denunciados</div>
                    <div class="denuncia-list">
                        ${topMateriais.map(([mat, count], idx) => `
                            <div class="denuncia-item">
                                <span>${idx + 1}. ${mat.substring(0, 20)}</span>
                                <span class="badge">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="denuncia-card">
                    <div class="denuncia-card-header">üìä Status das Den√∫ncias</div>
                    <div class="denuncia-list">
                        ${Object.entries(statusCounts).slice(0, 5).map(([status, count]) => `
                            <div class="denuncia-item">
                                <span>${status.substring(0, 25)}</span>
                                <span class="badge">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Atualizar tabela de materiais
            const materiaisTbody = document.querySelector('#materiaisTable tbody');
            materiaisTbody.innerHTML = topMateriais.map(([mat, count], idx) => {
                const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${mat}</td>
                        <td><strong>${count}</strong></td>
                        <td>${pct}%</td>
                    </tr>
                `;
            }).join('');

            // Atualizar gr√°ficos
            renderDenunciasCharts(filteredData);
        }

        function renderDenunciasCharts(data) {
            // Gr√°fico de cidades
            const cidadeCounts = {};
            data.forEach(item => {
                const cidade = item['Cidade'] || '';
                cidadeCounts[cidade] = (cidadeCounts[cidade] || 0) + 1;
            });

            const topCidades = Object.entries(cidadeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx1 = document.getElementById('cidadeChart').getContext('2d');
            if (cidadeChart) cidadeChart.destroy();
            
            cidadeChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: topCidades.map(c => c[0]),
                    datasets: [{
                        label: 'Den√∫ncias',
                        data: topCidades.map(c => c[1]),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });

            // Gr√°fico de tipos de barricada
            const tipoCounts = {};
            data.forEach(item => {
                const tipo = item['Tipo de Barricada'] || 'Desconhecido';
                tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
            });

            const tiposData = Object.entries(tipoCounts).sort((a, b) => b[1] - a[1]);

            const ctx2 = document.getElementById('tipoBarricadaChart').getContext('2d');
            if (tipoBarricadaChart) tipoBarricadaChart.destroy();
            
            tipoBarricadaChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: tiposData.map(t => t[0]),
                    datasets: [{
                        label: 'Quantidade',
                        data: tiposData.map(t => t[1]),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function showCidadesModal() {
            const tbody = document.getElementById('cidadesTableBody');
            const total = denunciasData.total;
            
            const cidadesArray = Object.entries(denunciasData.cidadeCounts)
                .sort((a, b) => b[1] - a[1]);
            
            tbody.innerHTML = cidadesArray.map(([cidade, count], idx) => {
                const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${cidade}</td>
                        <td><strong>${count}</strong></td>
                        <td>${pct}%</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('cidadesModal').style.display = 'block';
        }

        function closeCidadesModal() {
            document.getElementById('cidadesModal').style.display = 'none';
        }

        function showDuplicatesModal() {
            const container = document.getElementById('duplicatesList');
            const cidade = document.getElementById('cidadeFilter').value;
            
            // Filtrar dados novamente para garantir consist√™ncia com o dashboard
            const filteredData = cidade ? 
                denunciasData.denuncias.filter(d => (d['Cidade'] || '') === cidade) : 
                denunciasData.denuncias;

            const currentDuplicateMap = new Map();
            filteredData.forEach(item => {
                const endereco = (item['Endere√ßo'] || '').toString().trim().toUpperCase();
                if (endereco && endereco.toUpperCase() !== 'NI') {
                    if (!currentDuplicateMap.has(endereco)) {
                        currentDuplicateMap.set(endereco, []);
                    }
                    currentDuplicateMap.get(endereco).push(item);
                }
            });

            const duplicates = [];
            currentDuplicateMap.forEach((items, endereco) => {
                if (items.length > 1) {
                    duplicates.push({ endereco, items });
                }
            });

            // Ordenar por n√∫mero de ocorr√™ncias
            duplicates.sort((a, b) => b.items.length - a.items.length);

            if (duplicates.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Nenhuma duplicidade encontrada para os filtros atuais.</div>';
            } else {
                container.innerHTML = duplicates.map(dup => {
                    // Extrair os n√∫meros de DD de cada item
                    const numerosDD = dup.items.map(item => item['N¬∞ DD'] || item['N¬∫ DD'] || 'N/A').join(', ');
                    const enderecoLimpo = limparTextoParaPDF(dup.endereco);
                    
                    return `
                        <div style="background: var(--surface-light); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--danger);">
                            <div style="font-weight: 700; color: var(--text); margin-bottom: 0.5rem; font-size: 1.1rem;">üìç ${enderecoLimpo}</div>
                            <div style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 0.8rem; display: flex; flex-direction: column; gap: 4px;">
                                <span><strong>Localidade:</strong> ${dup.items[0]['Localidade'] || 'N/A'}</span>
                                <span><strong>Cidade:</strong> ${dup.items[0]['Cidade'] || 'N/A'}</span>
                                <span><strong>Ocorr√™ncias:</strong> ${dup.items.length} den√∫ncias neste endere√ßo</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--accent); font-weight: 700; margin-bottom: 0.5rem;">N√∫meros de Registro que Fazem Men√ß√£o ao Mesmo Endere√ßo:</div>
                                <div style="font-family: 'Space Mono', monospace; color: var(--text); word-break: break-all;">${numerosDD}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('duplicatesModal').style.display = 'block';
        }

        function closeDuplicatesModal() {
            document.getElementById('duplicatesModal').style.display = 'none';
        }

        // Fun√ß√£o para limpar texto para PDF (resolve problema de caracteres)
        function limparTextoParaPDF(texto) {
            if (!texto) return '';
            
            // Substituir caracteres problem√°ticos
            const mapaSubstituicao = {
                '√°': 'a', '√†': 'a', '√£': 'a', '√¢': 'a', '√§': 'a',
                '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e',
                '√≠': 'i', '√¨': 'i', '√Æ': 'i', '√Ø': 'i',
                '√≥': 'o', '√≤': 'o', '√µ': 'o', '√¥': 'o', '√∂': 'o',
                '√∫': 'u', '√π': 'u', '√ª': 'u', '√º': 'u',
                '√ß': 'c',
                '√Å': 'A', '√Ä': 'A', '√É': 'A', '√Ç': 'A', '√Ñ': 'A',
                '√â': 'E', '√à': 'E', '√ä': 'E', '√ã': 'E',
                '√ç': 'I', '√å': 'I', '√é': 'I', '√è': 'I',
                '√ì': 'O', '√í': 'O', '√ï': 'O', '√î': 'O', '√ñ': 'O',
                '√ö': 'U', '√ô': 'U', '√õ': 'U', '√ú': 'U',
                '√á': 'C',
                '¬∫': '¬∞', '¬™': 'a',
                '‚Äì': '-', '‚Äî': '-',
                '"': '"', "'": "'",
                '‚Ä¶': '...', '‚Ä¢': '*'
            };
            
            let textoLimpo = '';
            for (let i = 0; i < texto.length; i++) {
                const char = texto[i];
                textoLimpo += mapaSubstituicao[char] || char;
            }
            
            return textoLimpo;
        }

        function generateRecolocacoesPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ 
                orientation: 'portrait', 
                unit: 'mm', 
                format: 'a4',
                compress: true
            });
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;
            
            // Configurar fonte padr√£o (Helvetica suporta caracteres latinos b√°sicos)
            pdf.setFont('helvetica');
            
            // T√≠tulo
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(59, 130, 246); // Azul
            pdf.text('RELAT√ìRIO DE RECOLOCA√á√ïES DE BARRICADAS', pageWidth / 2, y, { align: 'center' });
            y += 8;
            
            // Subt√≠tulo com informa√ß√µes de filtro
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(100, 100, 100);
            
            const cidadeFiltro = document.getElementById('cidadeFilter').value || 'Todas as Cidades';
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            pdf.text(`Filtro aplicado: ${limparTextoParaPDF(cidadeFiltro)}`, pageWidth / 2, y, { align: 'center' });
            y += 5;
            pdf.text(`Gerado em: ${dataAtual} √†s ${horaAtual}`, pageWidth / 2, y, { align: 'center' });
            y += 12;
            
            // Obter dados filtrados
            const cidade = document.getElementById('cidadeFilter').value;
            const filteredData = cidade ? 
                denunciasData.denuncias.filter(d => (d['Cidade'] || '') === cidade) : 
                denunciasData.denuncias;

            const currentDuplicateMap = new Map();
            filteredData.forEach(item => {
                const endereco = (item['Endere√ßo'] || '').toString().trim();
                if (endereco && endereco.toUpperCase() !== 'NI' && endereco !== '') {
                    if (!currentDuplicateMap.has(endereco)) {
                        currentDuplicateMap.set(endereco, []);
                    }
                    currentDuplicateMap.get(endereco).push(item);
                }
            });

            const duplicates = [];
            currentDuplicateMap.forEach((items, endereco) => {
                if (items.length > 1) {
                    duplicates.push({ 
                        endereco: limparTextoParaPDF(endereco),
                        items,
                        localidade: limparTextoParaPDF(items[0]['Localidade'] || ''),
                        cidade: limparTextoParaPDF(items[0]['Cidade'] || ''),
                        count: items.length
                    });
                }
            });

            // Ordenar por n√∫mero de ocorr√™ncias
            duplicates.sort((a, b) => b.count - a.count);

            // Calcular m√©tricas para o PDF
            const totalEnderecosUnicos = Array.from(currentDuplicateMap.keys()).length;
            const totalEnderecosReincidentes = duplicates.length;
            const totalRegistrosAfetados = duplicates.reduce((sum, dup) => sum + dup.count, 0);
            const totalDenuncias = filteredData.length;
            
            // Calcular taxa de recoloca√ß√£o para dados filtrados
            const taxaRecolocacaoFiltrada = denunciasData.totalRemocoesGlobal > 0 
                ? ((totalEnderecosUnicos / (denunciasData.totalRemocoesGlobal/4)) * 100).toFixed(1)
                : 0;

            // Calcular efici√™ncia operacional
            const eficienciaOperacional = (100 - parseFloat(taxaRecolocacaoFiltrada)).toFixed(1);

            // Se√ß√£o de resumo com taxa de recoloca√ß√£o
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(30, 30, 30);
            pdf.text('RESUMO ESTAT√çSTICO E TAXA DE RECOLOCA√á√ÉO', margin, y);
            y += 8;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            const stats = [
                `Total de den√∫ncias analisadas: ${totalDenuncias}`,
                `Total de remo√ß√µes: ${(denunciasData.totalRemocoesGlobal/4)}`,
                `Endere√ßos √∫nicos com barricadas recolocadas: ${totalEnderecosUnicos}`,
                `Endere√ßos com recoloca√ß√£o (duplicados): ${totalEnderecosReincidentes}`,
                `Endere√ßos com mais de uma den√∫ncia: ${totalRegistrosAfetados}`,
                `Taxa de recoloca√ß√£o: ${taxaRecolocacaoFiltrada}% (${totalEnderecosUnicos}/${(denunciasData.totalRemocoesGlobal/4)})`,
                `Efici√™ncia operacional: ${eficienciaOperacional}%`
            ];
            
            stats.forEach(stat => {
                pdf.text(`‚Ä¢ ${limparTextoParaPDF(stat)}`, margin, y);
                y += 6;
            });
            
            y += 10;
            
            // Se√ß√£o de endere√ßos duplicados
            if (duplicates.length > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(239, 68, 68); // Vermelho para alerta
                pdf.text(`ENDERE√áOS DUPLICADOS COM DEN√öNCIAS DE RECOLOCA√á√ÉO DE BARRICADAS(${duplicates.length})`, margin, y);
                y += 8;
                
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(80, 80, 80);
                
                // Adicionar legenda
                pdf.text('Os endere√ßos abaixo apresentam m√∫ltiplas den√∫ncias, indicando recoloca√ß√£o de barricadas ap√≥s remo√ß√£o:', margin, y);
                y += 6;
                
                duplicates.forEach((dup, index) => {
                    // Verificar se precisa de nova p√°gina
                    if (y > 250) {
                        pdf.addPage();
                        y = margin;
                        pdf.setFontSize(10);
                    }
                    
                    // T√≠tulo do endere√ßo
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(30, 30, 30);
                    pdf.text(`${index + 1}. ${dup.endereco}`, margin, y);
                    y += 5;
                    
                    // Informa√ß√µes do endere√ßo
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(100, 100, 100);
                    
                    const localInfo = [];
                    if (dup.localidade && dup.localidade.trim() !== '') {
                        localInfo.push(`Localidade: ${dup.localidade}`);
                    }
                    if (dup.cidade && dup.cidade.trim() !== '') {
                        localInfo.push(`Cidade: ${dup.cidade}`);
                    }
                    localInfo.push(`Ocorr√™ncias: ${dup.count}`);
                    
                    pdf.text(localInfo.join(' | '), margin, y);
                    y += 5;
                    
                    // N√∫meros de registro
                    const numerosDD = dup.items.map(item => item['N¬∞ DD'] || item['N¬∫ DD'] || 'N/A').filter(n => n !== 'N/A');
                    if (numerosDD.length > 0) {
                        pdf.setTextColor(59, 130, 246); // Azul
                        pdf.setFont(undefined, 'bold');
                        pdf.text('Registros relacionados:', margin, y);
                        y += 4;
                        
                        pdf.setFont(undefined, 'normal');
                        pdf.setTextColor(80, 80, 80);
                        
                        // Dividir os n√∫meros de registro em linhas se for muito longo
                        const registrosText = numerosDD.join(', ');
                        const maxCharsPerLine = 80;
                        
                        if (registrosText.length <= maxCharsPerLine) {
                            pdf.text(registrosText, margin + 5, y);
                            y += 4;
                        } else {
                            // Quebrar o texto em v√°rias linhas
                            let start = 0;
                            while (start < registrosText.length) {
                                let end = start + maxCharsPerLine;
                                if (end < registrosText.length) {
                                    // Encontrar o √∫ltimo espa√ßo antes do limite
                                    while (end > start && registrosText[end] !== ' ' && registrosText[end] !== ',') {
                                        end--;
                                    }
                                    if (end === start) {
                                        end = start + maxCharsPerLine; // For√ßar quebra
                                    }
                                } else {
                                    end = registrosText.length;
                                }
                                
                                const linha = registrosText.substring(start, end).trim();
                                if (linha) {
                                    pdf.text(linha, margin + 5, y);
                                    y += 4;
                                }
                                start = end;
                            }
                        }
                    }
                    
                    y += 8; // Espa√ßo entre itens
                    
                    // Linha divis√≥ria
                    if (index < duplicates.length - 1) {
                        pdf.setDrawColor(200, 200, 200);
                        pdf.line(margin, y - 2, pageWidth - margin, y - 2);
                        y += 4;
                    }
                });
            } else {
                pdf.setFontSize(11);
                pdf.setTextColor(100, 100, 100);
                pdf.text('Nenhum endere√ßo com recoloca√ß√£o identificado para os filtros atuais.', margin, y);
                y += 8;
            }
            
            // Se√ß√£o de an√°lise da taxa de recoloca√ß√£o
            y += 5;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(30, 30, 30);
            pdf.text('AN√ÅLISE DA TAXA DE RECOLOCA√á√ÉO', margin, y);
            y += 8;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            const analiseText = `
A taxa de recoloca√ß√£o de ${taxaRecolocacaoFiltrada}% indica que, para cada 100 barricadas removidas, aproximadamente ${parseFloat(taxaRecolocacaoFiltrada).toFixed(0)} s√£o recolocadas.

Esta m√©trica √© calculada comparando:
‚Ä¢ Volume total de barricadas removidas (coluna "REMO√á√ïES", √≠ndice 5 da aba GLOBAL): ${(denunciasData.totalRemocoesGlobal/4)}
‚Ä¢ Endere√ßos √∫nicos com recoloca√ß√£o (aba Recoloca√ß√£o.DD): ${totalEnderecosUnicos}

F√≥rmula: (Endere√ßos √önicos Recolocados √∑ Total de Remo√ß√µes) √ó 100

Interpreta√ß√£o:
‚Ä¢ Taxa abaixo de 10%: Excelente efici√™ncia operacional
‚Ä¢ Taxa entre 10-30%: Efici√™ncia moderada
‚Ä¢ Taxa acima de 30%: Necessidade de revis√£o estrat√©gica

Efici√™ncia Operacional: ${eficienciaOperacional}%
            `;
            
            const linhasAnalise = analiseText.split('\n');
            linhasAnalise.forEach(linha => {
                if (linha.trim()) {
                    pdf.text(linha.trim(), margin, y);
                    y += 6;
                }
            });
            
            // Adicionar rodap√© em todas as p√°ginas
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(150, 150, 150);
                pdf.text(`P√°gina ${i} de ${pageCount}`, pageWidth - margin, pdf.internal.pageSize.getHeight() - 10, { align: 'right' });
                pdf.text('Opera√ß√£o Barricada Zero - Sistema Integrado de An√°lise Operacional', margin, pdf.internal.pageSize.getHeight() - 10);
            }
            
            // Abrir o PDF em uma nova aba
            const pdfDataUrl = pdf.output('datauristring');
            currentPDFDataUrl = pdfDataUrl;
            
            // Criar um blob URL para abrir em nova aba
            const pdfBlob = pdf.output('blob');
            const blobUrl = URL.createObjectURL(pdfBlob);
            window.open(blobUrl, '_blank');
            
            // Limpar o blob URL ap√≥s um tempo
            setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
        }

        function closePdfPreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
            document.getElementById('pdfPreviewIframe').src = '';
        }

        function downloadPDFFromPreview() {
            if (currentPDFDataUrl) {
                const link = document.createElement('a');
                link.href = currentPDFDataUrl;
                link.download = `relatorio_recolocacoes_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ======================= FUN√á√ïES DE EXPORTA√á√ÉO =======================
        function generateDenunciasPDFContent() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const maxLineWidth = pageWidth - 2 * margin;
            const lineHeight = 7;
            let y = 20;

            // Cabe√ßalho
            pdf.setFillColor(78, 84, 200);
            pdf.rect(0, 0, pageWidth, 45, 'F');
            pdf.setFontSize(22);
            pdf.setTextColor(255);
            pdf.text('Relat√≥rio de Den√∫ncias de Barricadas', pageWidth/2, 28, { align: 'center' });
            pdf.setFontSize(12);
            pdf.text(`Gerado em: ${new Date().toLocaleString('pt-BR')} | Filtro: ${document.getElementById('cidadeFilter').value || 'Todas as Cidades'}`, pageWidth/2, 38, { align: 'center' });
            y = 55;

            pdf.setFontSize(16);
            pdf.setTextColor(0);
            pdf.text('Insights Principais', margin, y);
            y += 12;

            pdf.setFontSize(12);
            
            // Calcular estat√≠sticas para o PDF
            const cidade = document.getElementById('cidadeFilter').value;
            const filteredData = cidade ? 
                denunciasData.denuncias.filter(d => (d['Cidade'] || '') === cidade) : 
                denunciasData.denuncias;
            
            const total = filteredData.length;
            
            // Recalcular para dados filtrados
            const currentDuplicateMap = new Map();
            filteredData.forEach(item => {
                const endereco = (item['Endere√ßo'] || '').toString().trim().toUpperCase();
                const key = endereco;
                
                if (endereco && endereco !== 'NI') {
                    if (!currentDuplicateMap.has(key)) {
                        currentDuplicateMap.set(key, []);
                    }
                    currentDuplicateMap.get(key).push(item);
                }
            });

            // Calcular m√©tricas de duplicados para o PDF
            let totalEnderecosUnicosFiltrados = 0;
            let totalEnderecosReincidentesFiltrados = 0;
            let totalRegistrosAfetadosFiltrados = 0;

            currentDuplicateMap.forEach((items, key) => {
                if (key && key !== 'NI') {
                    totalEnderecosUnicosFiltrados++;
                    if (items.length > 1) {
                        totalEnderecosReincidentesFiltrados++;
                        totalRegistrosAfetadosFiltrados += items.length;
                    }
                }
            });

            // Calcular taxa de recoloca√ß√£o para o PDF (mesma f√≥rmula usada no dashboard)
            const taxaRecolocacaoFiltrada = denunciasData.totalRemocoesGlobal > 0 
                ? ((totalEnderecosUnicosFiltrados / (denunciasData.totalRemocoesGlobal/4)) * 100).toFixed(1)
                : 0;

            // Calcular efici√™ncia operacional
            const eficienciaOperacional = (100 - parseFloat(taxaRecolocacaoFiltrada)).toFixed(1);

            const insights = [
                `Total de den√∫ncias analisadas: ${total}`,
                `Total de remo√ß√µes: ${(denunciasData.totalRemocoesGlobal/4)}`,
                `Total de endere√ßos √∫nicos (barricadas recolocadas): ${totalEnderecosUnicosFiltrados}`,
                `Endere√ßos duplicados: ${totalEnderecosReincidentesFiltrados}`,
                `Total de endere√ßos mencionados mais de uma vez: ${totalRegistrosAfetadosFiltrados}`,
                `Taxa de recoloca√ß√£o: ${taxaRecolocacaoFiltrada}%`,
                `Efici√™ncia operacional: ${eficienciaOperacional}%`,
                `A taxa de recoloca√ß√£o indica a efic√°cia das opera√ß√µes de remo√ß√£o.`
            ];

            insights.forEach(insight => {
                const text = `‚Ä¢ ${insight}`;
                const lines = pdf.splitTextToSize(text, maxLineWidth);
                pdf.text(lines, margin, y);
                y += lines.length * lineHeight + 3;
                if (y > pdf.internal.pageSize.getHeight() - 30) {
                    pdf.addPage();
                    y = 20;
                }
            });

            y += 10;

            // Se√ß√£o Detalhes de Duplicados
            if (totalEnderecosReincidentesFiltrados > 0) {
                pdf.setFontSize(14);
                pdf.text('Endere√ßos com Reincid√™ncia de Den√∫ncias', margin, y);
                y += 10;

                const duplicatesList = [];
                currentDuplicateMap.forEach((items, endereco) => {
                    if (items.length > 1 && endereco && endereco !== 'NI') {
                        const numerosDD = items.map(item => item['N¬∞ DD'] || 'N/A').join(', ');
                        duplicatesList.push([limparTextoParaPDF(endereco), items.length, limparTextoParaPDF(numerosDD)]);
                    }
                });

                duplicatesList.sort((a, b) => b[1] - a[1]);

                pdf.autoTable({
                    startY: y,
                    head: [['Endere√ßo', 'Ocorr√™ncias', 'N√∫meros de Registro']],
                    body: duplicatesList.slice(0, 15),
                    theme: 'grid',
                    headStyles: { fillColor: [239, 68, 68], textColor: 255 },
                    styles: { fontSize: 9, cellPadding: 3, overflow: 'linebreak', valign: 'middle' },
                    columnStyles: { 
                        0: { cellWidth: 70 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 95 }
                    },
                    margin: { left: margin, right: margin }
                });
                
                y = pdf.lastAutoTable.finalY + 15;
            }

            // Se√ß√£o Materiais
            pdf.setFontSize(14);
            const materialsTitle = 'Materiais Mais Usados';
            pdf.text(materialsTitle, margin, y);
            y += 10;

            // Recalcular materiais para dados filtrados
            const materialCounts = {};
            filteredData.forEach(item => {
                const materiais = [
                    item['Material 1'],
                    item['Material 2'],
                    item['Material 3']
                ].filter(m => m && m !== 'NI' && m.trim() !== '');
                
                materiais.forEach(mat => {
                    const material = mat.trim().toUpperCase();
                    materialCounts[material] = (materialCounts[material] || 0) + 1;
                });
            });

            const mats = Object.entries(materialCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
                
            const matTable = mats.map(([mat, cnt], i) => [i+1, limparTextoParaPDF(mat), cnt]);
            pdf.autoTable({
                startY: y,
                head: [['Posi√ß√£o', 'Material', 'Ocorr√™ncias']],
                body: matTable,
                theme: 'grid',
                headStyles: { fillColor: [0, 198, 255], textColor: 255 },
                styles: { fontSize: 10, cellPadding: 4, overflow: 'linebreak', valign: 'middle' },
                columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 40 } },
                margin: { left: margin, right: margin }
            });

            pdf.setFontSize(10);
            pdf.text('Relat√≥rio gerado com base nos dados da planilha-base.', margin, pdf.internal.pageSize.getHeight() - 10);

            return pdf;
        }

        function previewDenunciasPDF() {
            if (!denunciasData) {
                alert('Por favor, importe os dados de den√∫ncias primeiro.');
                return;
            }

            const pdf = generateDenunciasPDFContent();
            const dataUrl = pdf.output('datauristring');
            currentPDFDataUrl = dataUrl;
            document.getElementById('pdfPreviewIframe').src = dataUrl;
            document.getElementById('pdfPreviewModal').style.display = 'block';
        }

        function exportDenunciasPDF() {
            if (!denunciasData) {
                alert('Por favor, importe os dados de den√∫ncias primeiro.');
                return;
            }

            const pdf = generateDenunciasPDFContent();
            pdf.save(`relatorio_denuncias_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportToPDF(type) {
            if (type === 'incursao') {
                exportIncursaoPDF();
            } else {
                exportDenunciasPDF();
            }
        }

        function exportIncursaoPDF() {
            if (!analysisData) {
                alert('Por favor, importe os dados de incurs√µes primeiro.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            
            // Implementa√ß√£o b√°sica - expandir conforme necess√°rio
            pdf.text('Relat√≥rio de Incurs√µes', 20, 20);
            pdf.text(`Total de √Åreas: ${analysisData.totalAreas}`, 20, 30);
            pdf.text(`Total de Endere√ßos: ${analysisData.totalAddresses}`, 20, 40);
            pdf.text(`Endere√ßos Duplicados: ${analysisData.totalDuplicates}`, 20, 50);
            
            pdf.save(`relatorio_incursao_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function printDashboard(type) {
            if (type === 'incursao') {
                if (!analysisData) {
                    alert('Por favor, importe os dados de incurs√µes primeiro.');
                    return;
                }
                window.print();
            } else {
                if (!denunciasData) {
                    alert('Por favor, importe os dados de den√∫ncias primeiro.');
                    return;
                }
                previewDenunciasPDF();
            }
        }
    </script>
</body>
</html>
